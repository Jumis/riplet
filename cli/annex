#!/bin/bash

### CLI Tools. 
PREV=$(pwd);
DIR="$( cd "$( dirname "${BASH_SOURCE[0]}" )" && pwd )";
CMD=$1;

### Env.
NAME=$("$DIR/branch");

TARGET="ubuntu";
BASEDIR="/root";
OUTDIR="/tmp";

NAME=${1-"$NAME"};
TARGET=${2-"$TARGET"};
BASEDIR=${3-"$BASEDIR"};

### Riplet (ripl) annex
if [ "$NAME" = "master" ]; then
echo "annex <package> [target] [basedir]";
echo "example: annex branch ubuntu /root";
else

if [ "1" = "1" ]; then
### Dependencies

ACTION="build";
APT="/riplet/service/$NAME/$TARGET/$ACTION.apt";
DEPS="/riplet/annex/ubuntu";
TEMP=$(mktemp -d);

read -r -d '' RIPLET_ENV_ARGS <<EOF
-cidfile $TEMP/$NAME.docker
-v $BASEDIR:/riplet:rw
-e RIPLET_HOME=/riplet
-e APT_DEPS="$APT"
foldersio-dev
EOF

cat <<'INLINE' > $TEMP/$NAME.sh;
cat <<'SCRIPT' |
if [ -f '/var/cache/apt/archives.annex' ]; then :
else
mv /var/cache/apt/archives /var/cache/apt/archives-origt
ln -s $DEPS /var/cache/apt/archives.annex 
ln -s /var/cache/apt/archives.annex /var/cache/apt/archives
apt-get -d install $(cat $APT_DEPS) -y;
fi
SCRIPT

INLINE

echo "docker run $RIPLET_ENV_ARGS /bin/bash -" >> $TEMP/$NAME.sh;
echo $TEMP/$NAME.sh;

fi;

if [ "1" = "1" ]; then

### FIXME: Imports are more gracefully handled through environment vars.
### Dependencies

ACTION="build";
GITHUB="/riplet/service/$NAME/$TARGET/$ACTION.github";
DEPS="/riplet/annex/github";
TEMP=$(mktemp -d);
TEMP_PID="$TEMP/$NAME.docker";
TEMP_SH="$TEMP/$NAME.sh";
RIPLET_HOME="/riplet";

read -r -d '' RIPLET_DOCKER_CMD <<EOF
docker run
 -cidfile $TEMP_PID
 -v $BASEDIR:$RIPLET_HOME:rw
 -e RIPLET_HOME=$RIPLET_HOME
 -e GITHUB=$GITHUB"
 -e DEPS=$DEPS
foldersio-dev /bin/bash -
EOF

cat <<'INLINE' >> $TEMP_SH;
cat <<'SCRIPT' |
TEMP=$(mktemp -d);
for $repo in $(cat $GITHUB); do
if [ -a "$repo" ]; then
git clone --separate-git-dir=$TEMP.git --depth 1 https://github.com/$repo $TEMP
mkdir -p "$DEPS/$repo";
rmdir "$DEPS/$repo";
git --git-dir=$TEMP.git bundle create $TEMP.bundle --all
tar -zcf $TEMP.tgz -C $TEMP
mv $TEMP.tgz "$DEPS/$repo.tgz"
mv $TEMP.bundle "$DEPS/$repo" 
fi;
done;
SCRIPT

INLINE

echo $RIPLET_DOCKER_CMD >> $TEMP_SH;
echo $TEMP_SH;

fi;




if [ "0" = "1" ]; then
### Base.

TEMP=`mktemp -d`;

BUILD_SCRIPT=$(cat <<EOF
mkdir -p /build/bin/$NAME;
/riplet/service/$NAME/$TARGET/build > /build/bin/$NAME/build.log 2>&1;
/riplet/service/$NAME/$TARGET/package > /build/bin/$NAME/package.log 2>&1;
EOF
);

ANNEX_SCRIPT=$(cat <<EOF
docker run -cidfile $TEMP/$NAME.docker -v $BASEDIR:/riplet:ro -e RIPLET_HOME=/riplet foldersio-dev /bin/bash -c "$BUILD_SCRIPT";
docker cp \$(cat $TEMP/$NAME.docker):/build/bin/$NAME $TEMP;
docker rm \$(cat $TEMP/$NAME.docker) > /dev/null 2>&1;
git bundle create $TEMP/$NAME.git --branches > /dev/null 2>&1;
EOF
);

echo "$ANNEX_SCRIPT" > $TEMP/$NAME.sh;

echo $TEMP/$NAME.sh;

fi;

fi;

